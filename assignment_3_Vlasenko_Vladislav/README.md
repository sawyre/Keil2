
# Задание 3 - ШИМ
# Срок сдачи: 22 апреля 2018 года, 01:00

Если вы выполняли задания на дополнительные баллы, **обязательно** поясните в отчете, что именно вы выполнили, какие граничные условия указали, нужно ли как-то активировать доп. задания и т.д.  
Практика показывает, что лучшее место для пояснений - комментарий к пулл-реквесту.  

Обязательно. Поясните. Пожалуйста. Поясните. Очень вас прошу. Очень сильно прошу вас. Пожалуйста. Пишите пояснения и пишите их там, где их легко найти!    
Если вы просто сдаете код, в котором ничего не понятно, в котором вы просто так поменяли все ноги для подключения, процессор, задание и вашу фамилию и на 337 строчке оставили комментарий "zapuskat vot tak", то не обижайтесь, когда я напишу "ничего не работает".

Например, пояснение к заданию про клавиатуру могло бы выглядеть вот так:

>Код написан для процессора F100, но Keil об этом не знает. Частота процессора 24 МГц.  
Матричная клавиатура подключена к портам PA.1..PA.7 так, что вход 1 подключён к PA.1, а вход 7 соответственно к PA.7. Разъём выполнен одним блоком.  
Динамик подключен как в задании к PB.10.  
В папке есть таблица с расчётом частот и тиков для нот.  
[Эту часть я только начал] В качестве светодиодной матрицы использована матрица 788BS 8х8. Столбцы подключены к пинам PA.8.. PA.15, строки к PB.1..PB.8. В папке есть картинка с подключением столбцов и строк к контактам матрицы.

# Задание

Задание из двух частей, для каждой части предусмотрен отдельный проект - part_1 и part_2 соответственно. Очень прошу вас воспользоваться ими.

## Часть первая

К выводу РС8 подключен светодиод. Необходимо плавно изменять яркость горения светодиода от минимума до максимума и обратно до минимума. Период изменения яркости - 2 секунды.

Для этого необходимо генерировать ШИМ; причем коэффициент заполнения должен плавно (например, линейно) меняться от 0 до максимума и обратно до минимума. ШИМ необходимо генерировать аппаратно, с помощью таймера общего назначения.

Требования:

 - Частота ШИМ должна быть не менее 100 Гц, чтобы изменение коэффициента заполнения воспринимались человеческим глазом как изменение якрости.
 - Изменение яркости не должно быть слишком резким, заполнение ШИМ должно иметь не менее 100 градаций ("ступенек" на графике). 
 - Допустимая погрешность периода изменения яркости - 1 миллисекунда.

## Часть вторая:

К выводу РС6 подключен динамик. Необходимо проиграть аккорд из трех нот равномерно темперированного строя.
Если в вашей фамилии четное число букв, то ваш аккорд - до-ми-соль третьей октавы.
Если в вашей фамилии нечетное число букв, то ваш аккорд - ре-фа-ля третьей октавы.

Чтобы проиграть аккорд, необходимо генерировать ШИМ с частотой не менее 140 КГц. Каждую ноту нужно представить как синусоидальный сигнал; чтобы проиграть несколько нот, сигналы нужно просто сложить.

ШИМ необходимо генерировать аппаратно, с помощью таймера общего назначения. 

Требования:
 - Заполнение ШИМ должно иметь не менее 100 градаций ("ступенек" на графике).
 - Допустимая погрешность частоты каждого синуса - 10 Гц.
 - Частота ШИМ должна быть не менее 140 КГц.

# Как проверять это задание?

## При отладке в симуляторе

Используйте виртуальный осциллограф. Вы можете добавить в осциллограф регистр GPIOx->IDR (где x - буква нужного вам порта), который всегда отражает состояние ножки процессора) и увидеть, что ШИМ действительно генерируется.

Примерно так:

![шим на ноге](.media/pwm_linear_pin.png)

Чтобы видеть график изменения заполнения ШИМ, добавьте в осциллограф регистр TIMx->CCRy (где x - номер таймера, а y - номер канала). Для первой части график может выглядеть, например, так (при линейном изменении заполнения):

![шим на ноге](.media/pwm_linear.png)

Для второй части график суммы трех синусоидальных сигналов будет выглядеть примерно так:

![шим на ноге](.media/pwm_three_sine.png)

Этот график позволит вам проверить:
 - Правильность амплитуды сигнала.
 - Правильность частоты сигнала (в первой части)
 - Отсутствие разрывов в сигнале.
 - Плавность изменения амплитуды.

Однако по этому графику трудно судить о правильности частот синусов в сигнале. Чтобы проверить их, вы можете модифицировать код и перед суммированием синусов, записывать значение каждого в отдельную глобальную переменную. А переменные (вместе с регистром TIMx->CCRy) добавить в осциллограф. Это позволит вам измерить частоту каждого синуса. 

Приблизительный вид:

![шим на ноге](.media/pwm_separate_sines.png)

**word of warning**: Убедитесь, что модификация кода для вывода синусов по отдельности не влияет на их частоты. Убедитесь, что заполнение ШИМ не превышает периода таймера (в противном случае истинное заполнение ШИМ будет 100%).

## При отладке на плате

Первая часть должна выглядеть приблизительно так:

![светодиодик](.media/led.gif)

Вторая часть должна звучать приблизительно так:

[Прямое включение с кефирной крышечки](https://vocaroo.com/i/s0uhLQBNaq5J)

# Задания на дополнительные баллы:

+2 Балла - Использовать только один таймер (считая SysTick).  
+3 Баллов - Проиграть (с платы, разумеется) одноканальный (т.е. моно) wav-файл, из папки wav в вашем репозитории. Будьте осторожны при прослушивании, чувство юмора преподавателя находится на уровне 4 класса средней школы!


